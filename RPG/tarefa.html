<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minhas Tarefas - Recife Point Game</title>
    <link rel="stylesheet" href="./src/css/tarefa.css" />
  </head>
  <body>
    <!-- Navbar -->

    <div class="tarefas-container">
      <h1>ğŸ“‹ Minhas Tarefas</h1>
      <div class="user-info" id="userInfo" style="text-align: center; margin-bottom: 20px; color: white;">
        <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
          <div class="stat-card">
            <span style="font-size: 1.1rem;">ğŸª™ <span id="userCapibas">0</span> capibas</span>
          </div>
          <div class="stat-card">
            <span style="font-size: 1.1rem;">âœ… <span id="userTarefasCompletas">0</span> tarefas completas</span>
          </div>
        </div>
      </div>
      
      <div class="lista-tarefas" id="listaTarefas">
        <div class="sem-tarefas" id="semTarefas">
          <h3>Carregando tarefas...</h3>
          <p>Aguarde enquanto buscamos seus pontos turÃ­sticos.</p>
        </div>
      </div>
    </div>

    <!-- Popup de ConfirmaÃ§Ã£o de Tarefa -->
    <div id="popupTarefa" class="popup-tarefa">
      <div class="popup-tarefa-content">
        <span class="close-popup" onclick="fecharPopupTarefa()">&times;</span>
        
        <div class="popup-header">
          <h2>ğŸ¯ Confirmar Tarefa</h2>
        </div>
        
        <div class="popup-info">
          <div class="info-item">
            <span class="info-label">ğŸ“ Local:</span>
            <span class="info-value" id="popupLocal">Carregando...</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">ğŸ’° Recompensa:</span>
            <span class="info-value" id="popupCapibas">0 capibas</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">ğŸ“ Tarefa:</span>
            <span class="info-value" id="popupDescricao">Carregando descriÃ§Ã£o...</span>
          </div>
        </div>
        
        <div class="popup-actions">
          <button class="btn-cancelar" onclick="fecharPopupTarefa()">
            Cancelar
          </button>
          <button class="btn-concluir" onclick="concluirTarefa()">
            âœ… Confirmar ConclusÃ£o
          </button>
        </div>
      </div>
    </div>

    <script src="./src/components/barra-superior/barra-superior-loader.js"></script>
    <script type="module">
      // Importar os serviÃ§os
      import { pinoService } from './src/services/pinoService.js';
      import { clienteService } from './src/services/clienteService.js';

      // VariÃ¡veis globais
      let tarefaAtual = null;
      let botaoAtual = null;
      let todasTarefas = [];
      let usuarioLogado = null;
      let tarefasConcluidas = [];

      // FunÃ§Ã£o para verificar se o usuÃ¡rio estÃ¡ logado
      function verificarLogin() {
        const userData = localStorage.getItem('user');
        if (!userData) {
          alert('âš ï¸ VocÃª precisa estar logado para acessar as tarefas!');
          window.location.href = 'login.html';
          return null;
        }
        
        try {
          const user = JSON.parse(userData);
          console.log('ğŸ‘¤ UsuÃ¡rio logado:', user);
          return user;
        } catch (error) {
          console.error('Erro ao parsear dados do usuÃ¡rio:', error);
          window.location.href = 'login.html';
          return null;
        }
      }

      // FunÃ§Ã£o para carregar dados do usuÃ¡rio
      async function carregarDadosUsuario() {
        try {
          usuarioLogado = verificarLogin();
          if (!usuarioLogado) return;

          console.log('ğŸ”„ Carregando dados do usuÃ¡rio...');
          
          // Buscar dados atualizados do cliente
          // Tenta por ID primeiro, depois por email
          let cliente;
          try {
            cliente = await clienteService.getCliente(usuarioLogado.id);
          } catch (error) {
            console.log('Tentando buscar por email...');
            cliente = await clienteService.getClienteByEmail(usuarioLogado.email);
          }
          
          // Atualizar dados do usuÃ¡rio
          usuarioLogado.capibas = cliente.capibas || 0;
          usuarioLogado.tarefasCompletas = cliente.tarefasCompletas || 0;
          tarefasConcluidas = cliente.tarefasConcluidas || [];

          console.log('âœ… Dados do usuÃ¡rio carregados:', {
            capibas: usuarioLogado.capibas,
            tarefasCompletas: usuarioLogado.tarefasCompletas,
            tarefasConcluidas: tarefasConcluidas.length
          });

          // Atualizar interface
          document.getElementById('userCapibas').textContent = usuarioLogado.capibas;
          document.getElementById('userTarefasCompletas').textContent = usuarioLogado.tarefasCompletas;
          
        } catch (error) {
          console.error('âŒ Erro ao carregar dados do usuÃ¡rio:', error);
          // Usar dados do localStorage como fallback
          usuarioLogado.capibas = usuarioLogado.capibas || 0;
          usuarioLogado.tarefasCompletas = usuarioLogado.tarefasCompletas || 0;
          tarefasConcluidas = usuarioLogado.tarefasConcluidas || [];
          
          document.getElementById('userCapibas').textContent = usuarioLogado.capibas;
          document.getElementById('userTarefasCompletas').textContent = usuarioLogado.tarefasCompletas;
        }
      }

      // FunÃ§Ã£o para carregar tarefas
      async function carregarTarefas() {
        try {
          console.log('ğŸ”„ Carregando tarefas da API...');
          
          const pinos = await pinoService.getPinos();
          
          // Transformar pinos em tarefas
          todasTarefas = pinos.map(pino => ({
            id: pino._id,
            nome: pino.nome,
            descricao: pino.msg,
            recompensa: pino.capibas || 0,
            concluida: tarefasConcluidas.includes(pino._id)
          }));
          
          console.log(`âœ… ${todasTarefas.length} tarefas carregadas`);
          console.log(`ğŸ“Š Tarefas concluÃ­das: ${todasTarefas.filter(t => t.concluida).length}`);
          
          exibirTarefas();
          
        } catch (error) {
          console.error('âŒ Erro ao carregar tarefas:', error);
          document.getElementById('semTarefas').innerHTML = `
            <h3>âŒ Erro ao carregar tarefas</h3>
            <p>NÃ£o foi possÃ­vel carregar os pontos turÃ­sticos. Verifique se o servidor estÃ¡ rodando.</p>
            <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #1449c0; color: white; border: none; border-radius: 5px; cursor: pointer;">
              Tentar Novamente
            </button>
          `;
        }
      }

      // FunÃ§Ã£o para exibir tarefas na tela
      function exibirTarefas() {
        const listaTarefas = document.getElementById('listaTarefas');
        const semTarefas = document.getElementById('semTarefas');
        
        if (todasTarefas.length === 0) {
          semTarefas.innerHTML = `
            <h3>ğŸ“­ Nenhuma tarefa disponÃ­vel</h3>
            <p>No momento nÃ£o hÃ¡ pontos turÃ­sticos cadastrados. Volte mais tarde!</p>
          `;
          semTarefas.style.display = 'block';
          return;
        }
        
        semTarefas.style.display = 'none';
        
        // Criar HTML para cada tarefa
        listaTarefas.innerHTML = todasTarefas.map(tarefa => `
          <div class="tarefa-item ${tarefa.concluida ? 'tarefa-concluida' : ''}" id="tarefa-${tarefa.id}">
            <span class="status ${tarefa.concluida ? 'status-concluida' : 'status-pendente'}">
              ${tarefa.concluida ? 'âœ… ConcluÃ­da' : 'ğŸ”´ Pendente'}
            </span>
            <h3>${tarefa.nome}</h3>
            <p>${tarefa.descricao}</p>
            <p class="recompensa">ğŸ¯ Recompensa: ${tarefa.recompensa} capibas</p>
            <button class="btn-confirmar" 
              ${tarefa.concluida ? 'disabled' : ''}
              onclick="abrirPopupTarefa(this, ${tarefa.recompensa}, '${tarefa.nome.replace(/'/g, "\\'")}', '${tarefa.descricao.replace(/'/g, "\\'")}', '${tarefa.id}')">
              ${tarefa.concluida ? 'Tarefa ConcluÃ­da' : 'Confirmar ConclusÃ£o'}
            </button>
          </div>
        `).join('');
      }

      // FunÃ§Ã£o para abrir popup de confirmaÃ§Ã£o
      function abrirPopupTarefa(botao, capibas, local, descricao, id) {
        tarefaAtual = { capibas, local, descricao, id };
        botaoAtual = botao;
        
        document.getElementById('popupLocal').textContent = local;
        document.getElementById('popupCapibas').textContent = `${capibas} capibas`;
        document.getElementById('popupDescricao').textContent = descricao;
        
        document.getElementById('popupTarefa').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      // FunÃ§Ã£o para fechar popup
      function fecharPopupTarefa() {
        document.getElementById('popupTarefa').style.display = 'none';
        document.body.style.overflow = 'auto';
        tarefaAtual = null;
        botaoAtual = null;
      }

      // FunÃ§Ã£o SIMPLIFICADA para concluir tarefa (usando localStorage como fallback)
      async function concluirTarefa() {
        if (!tarefaAtual || !botaoAtual || !usuarioLogado) return;
        
        try {
          // Tentar salvar no backend
          try {
            const resultado = await clienteService.concluirTarefa(
              usuarioLogado.id, 
              tarefaAtual.id, 
              tarefaAtual.capibas
            );
            
            // Atualizar com dados do backend
            usuarioLogado.capibas = resultado.capibas;
            usuarioLogado.tarefasCompletas = resultado.tarefasCompletas;
            
          } catch (backendError) {
            console.warn('âš ï¸ Usando fallback localStorage:', backendError.message);
            
            // Fallback: salvar no localStorage
            usuarioLogado.capibas = (usuarioLogado.capibas || 0) + tarefaAtual.capibas;
            usuarioLogado.tarefasCompletas = (usuarioLogado.tarefasCompletas || 0) + 1;
            
            if (!usuarioLogado.tarefasConcluidas) {
              usuarioLogado.tarefasConcluidas = [];
            }
            usuarioLogado.tarefasConcluidas.push(tarefaAtual.id);
            
            // Salvar no localStorage
            localStorage.setItem('user', JSON.stringify(usuarioLogado));
          }

          // Atualizar interface
          const tarefaItem = botaoAtual.closest('.tarefa-item');
          const status = tarefaItem.querySelector('.status');
          
          status.textContent = 'âœ… ConcluÃ­da';
          status.className = 'status status-concluida';
          
          botaoAtual.textContent = 'Tarefa ConcluÃ­da';
          botaoAtual.disabled = true;
          tarefaItem.classList.add('tarefa-concluida');

          // Atualizar estatÃ­sticas
          document.getElementById('userCapibas').textContent = usuarioLogado.capibas;
          document.getElementById('userTarefasCompletas').textContent = usuarioLogado.tarefasCompletas;

          // Atualizar array local
          const tarefaIndex = todasTarefas.findIndex(t => t.id === tarefaAtual.id);
          if (tarefaIndex !== -1) {
            todasTarefas[tarefaIndex].concluida = true;
          }

          // Feedback visual
          tarefaItem.style.transform = 'scale(1.02)';
          setTimeout(() => {
            tarefaItem.style.transform = 'scale(1)';
          }, 200);

          // Mensagem de sucesso
          alert(`ğŸ‰ ParabÃ©ns! VocÃª ganhou ${tarefaAtual.capibas} capibas!\n\n` +
                `ğŸ’° Total: ${usuarioLogado.capibas} capibas\n` +
                `âœ… Tarefas completas: ${usuarioLogado.tarefasCompletas}`);

          // Fechar popup
          fecharPopupTarefa();

        } catch (error) {
          console.error('Erro ao concluir tarefa:', error);
          alert('âŒ Erro ao concluir tarefa. Tente novamente.');
        }
      }

      // Event Listeners
      document.getElementById('popupTarefa').addEventListener('click', function(e) {
        if (e.target === this) fecharPopupTarefa();
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') fecharPopupTarefa();
      });

      // InicializaÃ§Ã£o
      document.addEventListener('DOMContentLoaded', async function() {
        // Configurar navbar
        const links = document.querySelectorAll('.barra-superior .meio a');
        links.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = link.getAttribute('href');
          });
        });

        const logoImg = document.querySelector('.logo-img');
        if (logoImg) {
          logoImg.addEventListener('click', () => {
            window.location.href = 'index.html';
          });
        }

        // Carregar dados
        await carregarDadosUsuario();
        await carregarTarefas();
      });

      // FunÃ§Ãµes globais
      window.abrirPopupTarefa = abrirPopupTarefa;
      window.fecharPopupTarefa = fecharPopupTarefa;
      window.concluirTarefa = concluirTarefa;
      window.carregarTarefas = carregarTarefas;
    </script>

    <style>
      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
    </style>
  </body>
</html>